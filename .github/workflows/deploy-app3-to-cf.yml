name: Deploy Python App 3 to Tanzu CF

on:
  push:
    branches: [ main ]
  workflow_dispatch:   # optional: allows manual trigger

jobs:
  deploy:
    runs-on: self-hosted   # runs on your Mac self-hosted runner

    steps:
      # -----------------------------------------
      # Checkout the app repo
      # -----------------------------------------
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          repository: kirtiapte/4-steps-python-demo-on-cf
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          path: app   # clones into ./app

      # -----------------------------------------
      # Authenticate to Tanzu CF
      # -----------------------------------------
      - name: Authenticate to Tanzu CF
        env:
          CF_API: ${{ secrets.CF_API }}
          CF_ORG: ${{ secrets.CF_ORG }}
          CF_SPACE: ${{ secrets.CF_SPACE }}
          CF_USERNAME: ${{ secrets.CF_USERNAME }}
          CF_PASSWORD: ${{ secrets.CF_PASSWORD }}
        run: |
          echo "Logging into Tanzu CF..."
          cf api "$CF_API" --skip-ssl-validation
          cf auth "$CF_USERNAME" "$CF_PASSWORD"
          cf target -o "$CF_ORG" -s "$CF_SPACE"

      # -----------------------------------------
      # Deploy the app from subfolder
      # -----------------------------------------
      - name: Deploy 03-cf-quotes-semantic
        run: |
          echo "Deploying app from 03-cf-quotes-semantic..."
          cd app/03-cf-quotes-semantic
          cf push cf-quotes-03-semantic-uv-with-githubaction -f manifest-uv.yml   # overrides manifest name

      # -----------------------------------------
      # Verify deployment
      # -----------------------------------------
      - name: Show deployed apps
        run: cf apps
